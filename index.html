<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Registration</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --danger-color: #f72585;
      --success-color: #4cc9f0;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    /* Dark mode variables */
    [data-theme="dark"] {
      --primary-color: #4895ef;
      --secondary-color: #4361ee;
      --accent-color: #3f37c9;
      --light-color: #212529;
      --dark-color: #f8f9fa;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      line-height: 1.6;
      color: var(--dark-color);
      background-color: var(--light-color);
      padding: 0;
      margin: 0;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px 0;
      margin-bottom: 30px;
      box-shadow: var(--box-shadow);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      font-size: 2rem;
      font-weight: 600;
    }
    
    h2 {
      color: var(--secondary-color);
      margin-bottom: 20px;
      font-weight: 500;
      border-bottom: 2px solid var(--accent-color);
      padding-bottom: 8px;
      display: inline-block;
    }
    
    .card {
      background: var(--light-color);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark-color);
    }
    
    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      transition: var(--transition);
      background-color: var(--light-color);
      color: var(--dark-color);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    .btn {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: var(--transition);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }
    
    .btn-danger {
      background: var(--danger-color);
    }
    
    .btn-danger:hover {
      background: #d1145a;
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-success {
      background: #28a745;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: var(--light-color);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }
    
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background: var(--primary-color);
      color: white;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background-color: rgba(72, 149, 239, 0.1);
    }
    
    .actions {
      display: flex;
      gap: 8px;
    }
    
    .actions button {
      padding: 8px 12px;
      font-size: 14px;
    }
    
    .no-employees {
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-style: italic;
    }
    
    /* Search and export controls */
    .table-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .search-container {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    
    .search-container i {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }
    
    .search-container input {
      padding-left: 35px;
    }
    
    .export-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* Advanced controls */
    .filters {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .per-page {
      width: 120px;
    }
    .columns-toggle {
      position: relative;
    }
    .columns-menu {
      position: absolute;
      right: 0;
      top: 110%;
      background: var(--light-color);
      color: var(--dark-color);
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 10px;
      display: none;
      z-index: 5;
      min-width: 200px;
    }
    .columns-menu label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    th.sortable {
      cursor: pointer;
      position: relative;
      user-select: none;
    }
    th.sortable::after {
      content: '\25B4\25BE';
      position: absolute;
      right: 10px;
      opacity: 0.4;
      font-size: 10px;
    }
    th.sortable.asc::after { content: '\25B4'; opacity: 1; }
    th.sortable.desc::after { content: '\25BE'; opacity: 1; }
    
    .pagination {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .pagination .page-btn {
      padding: 6px 10px;
      border: 1px solid #ddd;
      background: var(--light-color);
      color: var(--dark-color);
      border-radius: 6px;
      cursor: pointer;
    }
    .pagination .page-btn.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }
    .highlight {
      background: #ffeb3b66;
      border-radius: 3px;
      padding: 0 2px;
    }
    .inline-input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: var(--light-color);
      color: var(--dark-color);
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
    }
    .inline-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    /* Dark mode toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
    }
    
    /* Photo upload */
    .photo-upload {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .photo-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--accent-color);
      background-color: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-preview i {
      font-size: 2rem;
      color: #6c757d;
    }
    
    .upload-btn {
      position: relative;
      overflow: hidden;
    }
    
    .upload-btn input {
      position: absolute;
      font-size: 100px;
      opacity: 0;
      right: 0;
      top: 0;
      cursor: pointer;
    }
    
    /* Error messages */
    .error-message {
      color: var(--danger-color);
      font-size: 0.8rem;
      margin-top: 5px;
      display: none;
    }
    
    .input-error {
      border-color: var(--danger-color);
    }
    
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      
      .actions {
        flex-direction: column;
      }
      
      table {
        display: block;
        overflow-x: auto;
      }
      
      .table-controls {
        flex-direction: column;
      }
      
      .export-buttons {
        justify-content: flex-start;
      }
    }
    
    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card, table {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* Status message */
    .status-message {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: var(--border-radius);
      display: none;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    
    .success {
      background-color: rgba(76, 201, 240, 0.2);
      color: #0a9396;
      border-left: 4px solid #0a9396;
      display: block;
    }
    
    .error {
      background-color: rgba(247, 37, 133, 0.2);
      color: #ae2012;
      border-left: 4px solid #ae2012;
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <h1>Employee Registration Portal</h1>
      <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </header>
  
  <div class="container">
    <div id="statusMessage" class="status-message"></div>
    
    <div class="card">
      <h2>Employee Registration Form</h2>
      <form id="employeeForm">
        <input type="hidden" id="editingIndex" value="">
        <div class="form-group">
          <label for="fullName">Full Name:</label>
          <input type="text" id="fullName" required placeholder="Enter full name">
          <div class="error-message" id="fullNameError">Please enter a valid name (letters and spaces only)</div>
        </div>
        <div class="form-group">
          <label for="contactInfo">Contact Info:</label>
          <input type="text" id="contactInfo" required placeholder="Phone or email">
          <div class="error-message" id="contactInfoError">Please enter a valid email or phone number</div>
        </div>
        <div class="form-group">
          <label for="position">Position Applying For:</label>
          <select id="position" required>
            <option value="" disabled selected>Select a position</option>
            <option value="Security Service">Security Service</option>
            <option value="Stock Manager">Stock Manager</option>
            <option value="Control Room Service">Control Room Service</option>
            <option value="Secretary">Secretary</option>
          </select>
          <div class="error-message" id="positionError">Please select a position</div>
        </div>
        <div class="form-group">
          <label for="preferredShift">Preferred Shift:</label>
          <input type="text" id="preferredShift" required placeholder="Morning, Evening, or Night">
          <div class="error-message" id="shiftError">Please enter a valid shift preference</div>
        </div>
        <div class="form-group">
          <label>Employee Photo:</label>
          <div class="photo-upload">
            <div class="photo-preview" id="photoPreview">
              <i class="fas fa-user"></i>
              <img id="photoPreviewImg" style="display: none;">
            </div>
            <div class="upload-btn btn btn-secondary">
              <i class="fas fa-upload"></i> Upload Photo
              <input type="file" id="employeePhoto" accept="image/*">
            </div>
          </div>
        </div>
        <button type="submit" class="btn">Submit</button>
        <button type="button" id="cancelEdit" class="btn btn-secondary" style="display: none; margin-left: 10px;">Cancel</button>
      </form>
    </div>
    
    <div class="card">
      <div class="table-controls">
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search employees...">
        </div>
        <div class="filters">
          <select id="filterPosition" class="per-page">
            <option value="">All Positions</option>
            <option value="Security Service">Security Service</option>
            <option value="Stock Manager">Stock Manager</option>
            <option value="Control Room Service">Control Room Service</option>
            <option value="Secretary">Secretary</option>
          </select>
          <select id="pageSize" class="per-page">
            <option value="5">5 per page</option>
            <option value="10" selected>10 per page</option>
            <option value="20">20 per page</option>
          </select>
          <div class="columns-toggle">
            <button id="columnsBtn" class="btn btn-secondary"><i class="fas fa-columns"></i> Columns</button>
            <div id="columnsMenu" class="columns-menu">
              <label><input type="checkbox" data-col="photo" checked> Photo</label>
              <label><input type="checkbox" data-col="fullName" checked> Full Name</label>
              <label><input type="checkbox" data-col="contactInfo" checked> Contact Info</label>
              <label><input type="checkbox" data-col="position" checked> Position</label>
              <label><input type="checkbox" data-col="preferredShift" checked> Preferred Shift</label>
            </div>
          </div>
          <div class="export-buttons">
            <button id="exportCSV" class="btn btn-success">
              <i class="fas fa-file-csv"></i> Export CSV
            </button>
            <button id="exportPDF" class="btn btn-danger">
              <i class="fas fa-file-pdf"></i> Export PDF
            </button>
          </div>
        </div>
      </div>
      
      <h2>Registered Employees</h2>
      <table id="employeeTable">
        <thead>
          <tr>
            <th data-col="photo">Photo</th>
            <th class="sortable" data-key="fullName" data-col="fullName">Full Name</th>
            <th class="sortable" data-key="contactInfo" data-col="contactInfo">Contact Info</th>
            <th class="sortable" data-key="position" data-col="position">Position</th>
            <th class="sortable" data-key="preferredShift" data-col="preferredShift">Preferred Shift</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Employee data will be inserted here -->
        </tbody>
      </table>
      <div id="noEmployees" class="no-employees">No employees registered yet</div>
      <div id="pagination" class="pagination"></div>
    </div>
  </div>

  <!-- PDF.js library for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Optional: Firebase (enable by filling sup/firebase-config.js) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="sup/firebase-config.js"></script>

  <script>
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    
    // DOM elements
    const form = document.getElementById('employeeForm');
    const tableBody = document.querySelector('#employeeTable tbody');
    const noEmployeesMsg = document.getElementById('noEmployees');
    const statusMessage = document.getElementById('statusMessage');
    const cancelEditBtn = document.getElementById('cancelEdit');
    const themeToggle = document.getElementById('themeToggle');
    const searchInput = document.getElementById('searchInput');
    const exportCSV = document.getElementById('exportCSV');
    const exportPDF = document.getElementById('exportPDF');
    const employeePhoto = document.getElementById('employeePhoto');
    const photoPreview = document.getElementById('photoPreview');
    const photoPreviewImg = document.getElementById('photoPreviewImg');
    const filterPosition = document.getElementById('filterPosition');
    const pageSizeSelect = document.getElementById('pageSize');
    const pagination = document.getElementById('pagination');
    const sortableHeaders = document.querySelectorAll('th.sortable');
    const columnsBtn = document.getElementById('columnsBtn');
    const columnsMenu = document.getElementById('columnsMenu');
    
    // Error message elements
    const fullNameError = document.getElementById('fullNameError');
    const contactInfoError = document.getElementById('contactInfoError');
    const positionError = document.getElementById('positionError');
    const shiftError = document.getElementById('shiftError');
    
    let employees = JSON.parse(localStorage.getItem('employees')) || [];
    let currentPhoto = null;
    let currentPage = 1;
    let pageSize = parseInt(pageSizeSelect ? pageSizeSelect.value : 10, 10) || 10;
    let sortKey = '';
    let sortDir = 'asc';
    let currentFilter = '';
    let currentSearch = '';
    let visibleColumns = JSON.parse(localStorage.getItem('visibleColumns') || '{}');

    // Firestore (optional) state
    let firestore = null;
    let employeesCollection = null;

    function isFirestoreConfigured() {
      try {
        const cfg = window.FIREBASE_CONFIG || {};
        return !!(cfg.apiKey && cfg.projectId);
      } catch (_) { return false; }
    }

    function setupFirestore() {
      if (!window.firebase || !isFirestoreConfigured()) return false;
      try {
        if (firebase.apps && firebase.apps.length) {
          firestore = firebase.firestore();
        } else {
          firebase.initializeApp(window.FIREBASE_CONFIG);
          firestore = firebase.firestore();
        }
        employeesCollection = firestore.collection('employees');
        return true;
      } catch (e) {
        console.warn('Firestore init failed, falling back to localStorage', e);
        firestore = null;
        employeesCollection = null;
        return false;
      }
    }

    function generateLocalId() {
      return 'loc_' + Date.now() + '_' + Math.random().toString(36).slice(2);
    }

    async function loadFromFirestore() {
      if (!employeesCollection) return;
      try {
        const snapshot = await employeesCollection.orderBy('fullName').get();
        employees = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        localStorage.setItem('employees', JSON.stringify(employees));
        renderTable();
      } catch (e) {
        console.warn('Failed to load from Firestore, using localStorage', e);
      }
    }

    function syncAddToFirestore(emp) {
      if (!employeesCollection) return;
      const toSave = { fullName: emp.fullName || '', contactInfo: emp.contactInfo || '', position: emp.position || '', preferredShift: emp.preferredShift || '', photo: emp.photo || null };
      if (emp.id && !emp.id.startsWith('loc_')) {
        employeesCollection.doc(emp.id).set(toSave).catch(console.warn);
      } else {
        employeesCollection.add(toSave).then(ref => {
          emp.id = ref.id;
          localStorage.setItem('employees', JSON.stringify(employees));
          renderTable();
        }).catch(console.warn);
      }
    }

    function syncUpdateToFirestore(emp) {
      if (!employeesCollection) return;
      if (emp.id && !emp.id.startsWith('loc_')) {
        employeesCollection.doc(emp.id).set({ fullName: emp.fullName || '', contactInfo: emp.contactInfo || '', position: emp.position || '', preferredShift: emp.preferredShift || '', photo: emp.photo || null }).catch(console.warn);
      } else {
        // No remote id yet
        syncAddToFirestore(emp);
      }
    }

    function syncDeleteFromFirestore(emp) {
      if (!employeesCollection) return;
      if (emp && emp.id && !emp.id.startsWith('loc_')) {
        employeesCollection.doc(emp.id).delete().catch(console.warn);
      }
    }

    // Initialize the page
    init();

    function init() {
      renderTable();
      setupEventListeners();
      checkThemePreference();
      if (setupFirestore()) {
        loadFromFirestore();
      }
    }

    function setupEventListeners() {
      form.addEventListener('submit', handleFormSubmit);
      cancelEditBtn.addEventListener('click', cancelEdit);
      themeToggle.addEventListener('click', toggleTheme);
      searchInput.addEventListener('input', function(){ currentSearch = this.value.toLowerCase(); currentPage = 1; renderTable(); });
      if (filterPosition) filterPosition.addEventListener('change', function(){ currentFilter = this.value; currentPage = 1; renderTable(); });
      if (pageSizeSelect) pageSizeSelect.addEventListener('change', function(){ pageSize = parseInt(this.value, 10); currentPage = 1; renderTable(); });
      sortableHeaders.forEach(h => h.addEventListener('click', () => handleSort(h)));
      exportCSV.addEventListener('click', exportToCSV);
      exportPDF.addEventListener('click', exportToPDF);
      employeePhoto.addEventListener('change', handlePhotoUpload);
      // Columns toggle menu
      if (columnsBtn && columnsMenu) {
        columnsBtn.addEventListener('click', function(e){
          e.preventDefault();
          columnsMenu.style.display = columnsMenu.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', function(e){
          if (!columnsMenu.contains(e.target) && !columnsBtn.contains(e.target)) {
            columnsMenu.style.display = 'none';
          }
        });
        columnsMenu.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          const key = cb.getAttribute('data-col');
          if (visibleColumns.hasOwnProperty(key)) {
            cb.checked = !!visibleColumns[key];
          } else {
            visibleColumns[key] = true;
          }
          cb.addEventListener('change', function(){
            visibleColumns[key] = cb.checked;
            localStorage.setItem('visibleColumns', JSON.stringify(visibleColumns));
            renderTable();
          });
        });
      }
      
      // Form validation listeners
      document.getElementById('fullName').addEventListener('input', validateFullName);
      document.getElementById('contactInfo').addEventListener('input', validateContactInfo);
      document.getElementById('position').addEventListener('change', validatePosition);
      document.getElementById('preferredShift').addEventListener('input', validateShift);
    }

    function checkThemePreference() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem('theme');
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      
      if (currentTheme === 'dark') {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }
    }

    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'status-message ' + type;
      setTimeout(() => {
        statusMessage.style.opacity = '1';
      }, 10);
      
      setTimeout(() => {
        statusMessage.style.opacity = '0';
        setTimeout(() => {
          statusMessage.className = 'status-message';
        }, 300);
      }, 3000);
    }

    function getProcessedEmployees() {
      let list = [...employees];
      if (currentFilter) {
        list = list.filter(emp => (emp.position || '') === currentFilter);
      }
      if (currentSearch) {
        const term = currentSearch;
        list = list.filter(emp =>
          (emp.fullName || '').toLowerCase().includes(term) ||
          (emp.contactInfo || '').toLowerCase().includes(term) ||
          (emp.position || '').toLowerCase().includes(term) ||
          (emp.preferredShift || '').toLowerCase().includes(term)
        );
      }
      if (sortKey) {
        list.sort((a, b) => {
          const av = (a[sortKey] || '').toString().toLowerCase();
          const bv = (b[sortKey] || '').toString().toLowerCase();
          if (av < bv) return sortDir === 'asc' ? -1 : 1;
          if (av > bv) return sortDir === 'asc' ? 1 : -1;
          return 0;
        });
      }
      return list;
    }

    function renderTable() {
      const processed = getProcessedEmployees();
      const total = processed.length;
      tableBody.innerHTML = '';
      if (total === 0) {
        noEmployeesMsg.style.display = 'block';
        pagination.innerHTML = '';
        return;
      }
      noEmployeesMsg.style.display = 'none';
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const pageItems = processed.slice(start, start + pageSize);
      pageItems.forEach((emp, indexOnPage) => {
        const index = start + indexOnPage;
        const row = document.createElement('tr');
        row.innerHTML = buildRowHtml(emp, index);
        tableBody.appendChild(row);
      });
      renderPagination(totalPages);
      updateHeaderSortIndicators();
      applyColumnVisibility();
    }

    function buildRowHtml(emp, index) {
      const photoCell = `
        <td data-col="photo">
          ${emp.photo ? 
            `<img src="${emp.photo}" alt="${emp.fullName}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : 
            `<i class="fas fa-user" style="font-size: 1.5rem; color: #6c757d;"></i>`}
        </td>`;
      const fullNameCell = `<td data-col="fullName" data-field="fullName">${highlight(emp.fullName)}</td>`;
      const contactCell = `<td data-col="contactInfo" data-field="contactInfo">${highlight(emp.contactInfo)}</td>`;
      const positionCell = `<td data-col="position" data-field="position">${highlight(emp.position)}</td>`;
      const shiftCell = `<td data-col="preferredShift" data-field="preferredShift">${highlight(emp.preferredShift)}</td>`;
      const actionsCell = `
        <td class="actions">
          <div class="inline-actions">
            <button onclick="enterInlineEdit(${index})" class="btn btn-secondary"><i class="fas fa-pen"></i> Edit</button>
            <button onclick="deleteEmployee(${index})" class="btn btn-danger"><i class="fas fa-trash"></i> Delete</button>
          </div>
        </td>`;
      return [photoCell, fullNameCell, contactCell, positionCell, shiftCell, actionsCell].join('');
    }

    function applyColumnVisibility() {
      const headerCells = document.querySelectorAll('th[data-col]');
      headerCells.forEach(h => {
        const key = h.getAttribute('data-col');
        const visible = visibleColumns.hasOwnProperty(key) ? visibleColumns[key] : true;
        h.style.display = visible ? '' : 'none';
      });
      const dataCells = document.querySelectorAll('td[data-col]');
      dataCells.forEach(c => {
        const key = c.getAttribute('data-col');
        const visible = visibleColumns.hasOwnProperty(key) ? visibleColumns[key] : true;
        c.style.display = visible ? '' : 'none';
      });
    }

    window.enterInlineEdit = function(index) {
      const row = Array.from(tableBody.querySelectorAll('tr')).find((_, idx) => (idx + ((currentPage - 1) * pageSize)) === index);
      if (!row) return;
      const emp = employees[index];
      const input = (name, value) => `<input class="inline-input" name="${name}" value="${(value || '').toString().replace(/"/g,'&quot;')}">`;
      const setCell = (field, val) => {
        const cell = row.querySelector(`td[data-field="${field}"]`);
        if (cell) cell.innerHTML = input(field, val);
      };
      setCell('fullName', emp.fullName);
      setCell('contactInfo', emp.contactInfo);
      setCell('position', emp.position);
      setCell('preferredShift', emp.preferredShift);
      const actions = row.querySelector('.inline-actions');
      actions.innerHTML = `
        <button onclick="saveInlineEdit(${index})" class="btn btn-success"><i class="fas fa-check"></i> Save</button>
        <button onclick="cancelInlineEdit()" class="btn btn-secondary"><i class="fas fa-times"></i> Cancel</button>
      `;
      applyColumnVisibility();
    };

    window.cancelInlineEdit = function() {
      renderTable();
    };

    window.saveInlineEdit = function(index) {
      const row = Array.from(tableBody.querySelectorAll('tr')).find((_, idx) => (idx + ((currentPage - 1) * pageSize)) === index);
      if (!row) return;
      const getVal = (field) => {
        const el = row.querySelector(`td[data-field="${field}"] input`);
        return el ? el.value.trim() : '';
      };
      const updated = {
        ...employees[index],
        fullName: getVal('fullName'),
        contactInfo: getVal('contactInfo'),
        position: getVal('position'),
        preferredShift: getVal('preferredShift')
      };
      // Reuse validators by injecting values into hidden form inputs
      document.getElementById('fullName').value = updated.fullName;
      document.getElementById('contactInfo').value = updated.contactInfo;
      document.getElementById('position').value = updated.position;
      document.getElementById('preferredShift').value = updated.preferredShift;
      if (!validateForm()) { showStatus('Please correct validation errors.', 'error'); return; }
      employees[index] = updated;
      localStorage.setItem('employees', JSON.stringify(employees));
      syncUpdateToFirestore(updated);
      showStatus('Employee updated successfully!', 'success');
      renderTable();
    };

    function renderPagination(totalPages) {
      pagination.innerHTML = '';
      const createBtn = (label, page, isActive = false, disabled = false) => {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.className = 'page-btn' + (isActive ? ' active' : '');
        btn.disabled = disabled;
        btn.addEventListener('click', () => { currentPage = page; renderTable(); });
        return btn;
      };
      pagination.appendChild(createBtn('«', 1, false, currentPage === 1));
      pagination.appendChild(createBtn('‹', Math.max(1, currentPage - 1), false, currentPage === 1));
      const start = Math.max(1, currentPage - 2);
      const end = Math.min(totalPages, start + 4);
      for (let p = start; p <= end; p++) {
        pagination.appendChild(createBtn(String(p), p, p === currentPage));
      }
      pagination.appendChild(createBtn('›', Math.min(totalPages, currentPage + 1), false, currentPage === totalPages));
      pagination.appendChild(createBtn('»', totalPages, false, currentPage === totalPages));
    }

    function handleSort(headerEl) {
      const key = headerEl.getAttribute('data-key');
      if (sortKey === key) {
        sortDir = sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        sortKey = key;
        sortDir = 'asc';
      }
      currentPage = 1;
      renderTable();
    }

    function updateHeaderSortIndicators() {
      sortableHeaders.forEach(h => {
        h.classList.remove('asc', 'desc');
        if (h.getAttribute('data-key') === sortKey) {
          h.classList.add(sortDir);
        }
      });
    }

    function escapeRegExp(string) {
      return string ? string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') : '';
    }

    function highlight(value) {
      const text = (value || '').toString();
      if (!currentSearch) return text;
      const pattern = new RegExp('(' + escapeRegExp(currentSearch) + ')', 'ig');
      return text.replace(pattern, '<span class="highlight">$1</span>');
    }

    function handleFormSubmit(event) {
      event.preventDefault();
      
      if (!validateForm()) {
        return;
      }
      
      const fullName = document.getElementById('fullName').value;
      const contactInfo = document.getElementById('contactInfo').value;
      const position = document.getElementById('position').value;
      const preferredShift = document.getElementById('preferredShift').value;
      const editingIndex = document.getElementById('editingIndex').value;

      const employee = { 
        id: (editingIndex === '' ? generateLocalId() : (employees[editingIndex] && employees[editingIndex].id) || generateLocalId()),
        fullName, 
        contactInfo, 
        position, 
        preferredShift,
        photo: currentPhoto
      };

      if (editingIndex === '') {
        employees.push(employee);
        showStatus('Employee added successfully!', 'success');
        syncAddToFirestore(employee);
      } else {
        employees[editingIndex] = employee;
        document.getElementById('editingIndex').value = '';
        cancelEditBtn.style.display = 'none';
        showStatus('Employee updated successfully!', 'success');
        syncUpdateToFirestore(employee);
      }

      localStorage.setItem('employees', JSON.stringify(employees));
      form.reset();
      currentPhoto = null;
      photoPreviewImg.style.display = 'none';
      photoPreview.querySelector('i').style.display = 'block';
      renderTable();
    }

    function cancelEdit() {
      form.reset();
      document.getElementById('editingIndex').value = '';
      cancelEditBtn.style.display = 'none';
      currentPhoto = null;
      photoPreviewImg.style.display = 'none';
      photoPreview.querySelector('i').style.display = 'block';
    }

    function handlePhotoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!file.type.match('image.*')) {
        showStatus('Please upload an image file', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        currentPhoto = e.target.result;
        photoPreviewImg.src = currentPhoto;
        photoPreviewImg.style.display = 'block';
        photoPreview.querySelector('i').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    // Deprecated: filterEmployees now handled inline with state

    function exportToCSV() {
      const view = getProcessedEmployees();
      if (view.length === 0) {
        showStatus('No employees to export', 'error');
        return;
      }
      
      let csv = 'Name,Contact,Position,Preferred Shift\n';
      
      view.forEach(emp => {
        csv += `"${emp.fullName}","${emp.contactInfo}","${emp.position}","${emp.preferredShift}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'employees.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportToPDF() {
      const view = getProcessedEmployees();
      if (view.length === 0) {
        showStatus('No employees to export', 'error');
        return;
      }
      
      const doc = new jsPDF();
      doc.text('Employee List', 14, 16);
      
      const headers = [['Name', 'Contact', 'Position', 'Preferred Shift']];
      const data = view.map(emp => [
        emp.fullName, 
        emp.contactInfo, 
        emp.position, 
        emp.preferredShift
      ]);
      
      doc.autoTable({
        head: headers,
        body: data,
        startY: 20,
        theme: 'grid',
        headStyles: {
          fillColor: [67, 97, 238],
          textColor: 255
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240]
        }
      });
      
      doc.save('employees.pdf');
    }

    // Form validation functions
    function validateForm() {
      const isNameValid = validateFullName();
      const isContactValid = validateContactInfo();
      const isPositionValid = validatePosition();
      const isShiftValid = validateShift();
      
      return isNameValid && isContactValid && isPositionValid && isShiftValid;
    }

    function validateFullName() {
      const nameInput = document.getElementById('fullName');
      const name = nameInput.value.trim();
      const isValid = /^[a-zA-Z\s]+$/.test(name) && name.length >= 3;
      
      if (isValid) {
        nameInput.classList.remove('input-error');
        fullNameError.style.display = 'none';
        return true;
      } else {
        nameInput.classList.add('input-error');
        fullNameError.style.display = 'block';
        return false;
      }
    }

    function validateContactInfo() {
      const contactInput = document.getElementById('contactInfo');
      const contact = contactInput.value.trim();
      const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contact);
      const isPhone = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/.test(contact);
      const isValid = isEmail || isPhone;
      
      if (isValid) {
        contactInput.classList.remove('input-error');
        contactInfoError.style.display = 'none';
        return true;
      } else {
        contactInput.classList.add('input-error');
        contactInfoError.style.display = 'block';
        return false;
      }
    }

    function validatePosition() {
      const positionSelect = document.getElementById('position');
      const isValid = positionSelect.value !== '';
      
      if (isValid) {
        positionSelect.classList.remove('input-error');
        positionError.style.display = 'none';
        return true;
      } else {
        positionSelect.classList.add('input-error');
        positionError.style.display = 'block';
        return false;
      }
    }

    function validateShift() {
      const shiftInput = document.getElementById('preferredShift');
      const shift = shiftInput.value.trim();
      const isValid = shift.length >= 3;
      
      if (isValid) {
        shiftInput.classList.remove('input-error');
        shiftError.style.display = 'none';
        return true;
      } else {
        shiftInput.classList.add('input-error');
        shiftError.style.display = 'block';
        return false;
      }
    }

    // Global functions for table actions
    window.editEmployee = function(index) {
      const emp = employees[index];
      document.getElementById('fullName').value = emp.fullName;
      document.getElementById('contactInfo').value = emp.contactInfo;
      document.getElementById('position').value = emp.position;
      document.getElementById('preferredShift').value = emp.preferredShift;
      document.getElementById('editingIndex').value = index;
      cancelEditBtn.style.display = 'inline-block';
      
      if (emp.photo) {
        currentPhoto = emp.photo;
        photoPreviewImg.src = emp.photo;
        photoPreviewImg.style.display = 'block';
        photoPreview.querySelector('i').style.display = 'none';
      } else {
        currentPhoto = null;
        photoPreviewImg.style.display = 'none';
        photoPreview.querySelector('i').style.display = 'block';
      }
      
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    };

    window.deleteEmployee = function(index) {
      if (confirm('Are you sure you want to delete this employee record?')) {
        const removed = employees.splice(index, 1)[0];
        localStorage.setItem('employees', JSON.stringify(employees));
        syncDeleteFromFirestore(removed);
        showStatus('Employee deleted successfully!', 'success');
        renderTable();
        
        // If we were editing this employee, cancel edit mode
        if (document.getElementById('editingIndex').value == index) {
          cancelEdit();
        }
      }
    };
  </script>
</body>
</html>